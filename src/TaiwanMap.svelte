<script>
  import { createEventDispatcher } from "svelte";
  import SVG from "./SVG.svelte";
  import { onMount } from "svelte";
  import toPair from "./utils/toPair";
  import polygonCentroid from "./utils/centroid";
  import hover from "./utils/useHover";
  import viewport from "./store/viewport";
  export let color;
  export let transform;
  let current = "";
  let group;
  let centroids = {};
  let texts = [];

  const dispatch = createEventDispatcher();

  onMount(() => {
    Array.from(group.children).forEach((node) => {
      let points = [];
      texts.push(node.id);
      if (node.hasAttribute("points")) {
        points = node.getAttribute("points").split(" ");
      }

      if (typeof color === "function") {
        const fillColor = color(node.id);
        node.setAttribute("fill", fillColor);
      }

      const pairs = toPair(points);
      const adjust = polygonCentroid(pairs);
      // handle some place
      switch (node.id) {
        case "臺中市":
          centroids[node.id] = [adjust[0] - 5, adjust[1] + 4];
          break;
        case "桃園市":
          centroids[node.id] = [adjust[0] - 3, adjust[1]];
          break;
        case "新北市":
          centroids[node.id] = [adjust[0] - 5, adjust[1] + 10];
          break;
        case "苗栗縣":
          centroids[node.id] = [adjust[0], adjust[1] + 3];
          break;
        case "高雄市":
          centroids[node.id] = [adjust[0], adjust[1] + 3];
          break;
        case "屏東縣":
          centroids[node.id] = [adjust[0] - 5, adjust[1]];
          break;
        default:
          centroids[node.id] = polygonCentroid(pairs);
      }
    });

    return () => (texts = []);
  });
</script>

<style>
  polygon {
    cursor: pointer;
    transition: transform ease 0.3s;
  }

  polygon:hover {
    transform: translate(-1px, -1px);
  }

  text {
    font-size: 6px;
    user-select: none;
    pointer-events: none;
  }
</style>

<SVG viewBox="0 0 {$viewport === 'mobile' ? 180 : 280} 266">
  <g {transform} fill="none" fill-rule="evenodd">
    <g
      stroke="#fff"
      stroke-width="0.5"
      id="台灣"
      fill-rule="nonzero"
      bind:this={group}
      use:hover={{ handler: (e) => dispatch('selected', e.target.id) }}>
      <polygon
        id="宜蘭縣"
        points="152.0175 24.7088 148.8528 25.845 143.0446 31.9831 140.5124 39.2467 143.104 52.4924 145.6746 54.4209 143.738 63.7878 138.333 69.6886 136.9964 76.9623 125.0755 72.9441 123.926 77.1686 111.797 73.0966 105.66 72.8239 102.0947 70.4675 101.2849 67.0866 101.536 66.4752 102.2233 65.4027 104.1 63.628 104.4296 63.5477 105.9566 61.7448 106.156 61.7487 106.5917 61.3969 106.9463 60.7942 107.1071 60.6147 107.133 60.6049 107.6871 57.7217 107.8329 57.5545 108.471 56.1986 108.4666 56.1879 108.2523 55.8896 108.2186 55.8429 107.9656 55.3326 112.3827 48.9593 113.9866 48.9052 123.1847 44.6935 122.7469 40.0122 130.3661 37.6784 137.5917 32.0394 143.1042 29.3523 142.7173 26.4868" />
      <polygon
        id="彰化縣"
        points="33.9065 85.42 37.6489 86.6751 39.8291 91.7004 46.098 93.605 47.0988 99.2694 51.2841 100.5335 48.3804 100.9942 46.7021 112.164 48.2893 118.3724 38.1705 117.2734 32.0716 114.9217 22.2921 115.6921 15.4249 112.0992 24.3278 100.5407 24.9493 96.9266 29.2331 92.438" />
      <polygon
        id="南投縣"
        points="103.2688 84.1393 103.7898 85.9639 98.8234 87.7538 98.4452 91.0001 102.1255 92.6619 96.782 102.2322 98.1747 104.3051 97.1842 111.5764 94.2965 118.4372 92.4425 119.4407 95.3001 124.4009 93.1052 132.9237 88.4317 133.9647 88.2254 138.5004 81.7909 139.3092 77.624 145.8087 73.105 143.1411 63.8294 143.0068 61.4537 137.9233 61.8678 132.8557 55.3703 132.0845 49.9195 132.1108 47.4056 130.1785 49.51 120.8987 48.2893 118.3724 46.7021 112.164 48.3804 100.9942 51.2841 100.5335 56.5573 101.7441 63.0723 96.0362 64.289 91.8877 70.1602 93.2247 75.7946 92.1746 80.5441 89.5216 96.3874 82.6006" />
      <polygon
        id="雲林縣"
        points="48.2893 118.3724 49.51 120.8987 47.4056 130.1785 49.9195 132.1108 55.3703 132.0845 55.7845 135.2417 48.7002 133.436 40.196 133.3426 37.5839 130.1696 29.6878 130.8223 22.2486 134.9102 15.6349 140.4168 9.5943 139.1253 9.0057 130.443 7.8822 129.5497 11.4207 120.4942 10.4481 118.4898 15.4249 112.0992 22.2921 115.6921 32.0716 114.9217 38.1705 117.2734" />
      <polygon
        id="基隆市"
        points="139.3003 12.7276 135.5874 14.9026 137.1246 17.908 133.7133 19.2607 127.7349 16.0729 125.4732 12.4604 131.9076 9.6418 131.9307 9.6162 131.9568 9.5696" />
      <polygon
        id="新北市"
        points="118.777 0.335, 125.186 1.953, 126.028 4.556, 131.957 9.570, 131.931 9.616, 131.908 9.642, 125.473 12.460, 127.735 16.073, 133.713 19.261, 137.125 17.908, 135.587 14.903, 139.300 12.728, 148.947 13.303, 148.052 17.276, 150.537 21.737, 154.490 21.860, 152.018 24.709, 142.717 26.487, 143.104 29.352, 137.592 32.039, 130.366 37.678, 122.747 40.012, 123.185 44.694, 113.987 48.905, 109.560 41.922, 111.602 40.135, 108.951 36.257, 105.998 36.336, 101.493 31.194, 102.027 25.132, 107.981 23.438, 107.029 18.572, 98.603 14.167, 106.927 11.825, 111.850 3.603, 118.777 0.335" />
      <polygon
        id="台北市"
        points="121.1064 7.9575 125.4283 15.8662 123.3911 25.1895 119.7703 24.6086 114.2719 20.623 116.1031 17.9168 112.3276 13.7654 115.753 9.8286" />

      <polygon
        id="臺中市"
        points="111.797 73.0966 110.4618 76.3922 103.2688 84.1393 96.3874 82.6006 80.5441 89.5216 75.7946 92.1746 70.1602 93.2247 64.289 91.8877 63.0723 96.0362 56.5573 101.7441 51.2841 100.5335 47.0988 99.2694 46.098 93.605 39.8291 91.7004 37.6489 86.6751 33.9065 85.42 39.164 76.9229 46.8407 67.1805 52.3262 72.8147 63.406 78.903 68.9591 78.7658 69.9354 75.3624 76.7981 75.6569 79.1904 78.3784 85.942 75.7572 92.6413 70.4969 94.5315 71.6097 96.6895 67.3569 98.0939 68.0445 98.5884 67.961 99.3813 67.8914 99.4241 67.8293 101.2849 67.0866 102.0947 70.4675 105.66 72.8239" />
      <polygon
        id="台南市"
        points="49.3126 162.3086 48.3467 165.562 43.1583 172.7247 35.7459 179.6442 34.2431 179.5698 30.7735 186.4215 25.9231 188.4835 11.8561 186.7866 8.9957 180.1257 0.4167 174.6722 7.4215 153.2614 15.465 156.7169 21.1051 150.5058 25.5314 148.4758 32.4827 147.5318 40.4355 154.2233 38.7956 161.157 43.4232 163.067" />
      <polygon
        id="苗栗縣"
        points="77.213 51.242, 77.235 51.250, 77.616 51.488, 79.772 52.556, 80.273 53.197, 80.454 53.302, 81.364 53.074, 81.637 53.345, 82.292 53.721, 82.304 53.740, 82.380 54.021, 82.324 54.315, 82.848 54.891, 82.894 55.514, 82.452 56.088, 82.144 56.772, 82.110 56.869, 81.768 57.633, 81.385 57.969, 81.028 57.764, 81.178 58.079, 82.166 58.635, 82.521 59.849, 82.076 62.367, 82.053 62.555, 83.369 62.586, 85.930 61.831, 88.114 61.957, 89.726 62.231, 93.727 62.770, 93.846 62.891, 94.694 63.490, 94.790 63.488, 95.557 64.781, 96.690 67.147, 97.931 67.954, 96.689 67.357, 94.531 71.610, 92.641 70.497, 85.942 75.757, 79.190 78.378, 76.798 75.657, 69.935 75.362, 68.959 78.766, 63.406 78.903, 52.326 72.815, 46.841 67.180, 50.248 63.791, 54.192 54.608, 59.887 49.441, 62.584 48.997, 67.990 44.281, 68.024 44.295, 68.032 44.298, 69.616 44.535, 69.686 45.508, 70.162 45.538, 70.610 45.672, 71.056 45.792, 71.221 45.840, 71.343 45.873, 72.762 46.376, 73.389 46.127, 74.316 46.665, 74.389 46.983, 74.017 48.075, 74.639 48.922, 75.089 49.191, 75.309 49.544, 75.567 49.753, 76.469 50.392, 77.069 50.313, 77.279 50.415, 77.269 50.476, 77.263 50.510, 77.148 50.651, 77.127 50.973, 77.213 51.242" />
      <polygon
        id="嘉義縣"
        points="55.3703 132.0845 61.8678 132.8557 61.4537 137.9233 63.8294 143.0068 73.105 143.1411 64.6275 147.0547 62.7555 150.7998 57.499 152.9404 52.9196 157.6227 48.7921 156.5995 49.3126 162.3086 43.4232 163.067 38.7956 161.157 40.4355 154.2233 32.4827 147.5318 25.5314 148.4758 21.1051 150.5058 15.465 156.7169 7.4215 153.2614 10.4939 149.7569 9.5943 139.1253 15.6349 140.4168 22.2486 134.9102 29.6878 130.8223 37.5839 130.1696 40.196 133.3426 48.7002 133.436 55.7845 135.2417" />
      <polygon
        id="高雄市"
        points="77.624 145.8087 78.5146 148.1067 75.4195 151.8085 80.2646 154.4727 78.6455 156.6292 74.1037 157.9215 69.8144 161.2936 67.4795 168.5617 66.9978 177.1655 62.4171 182.9336 65.8322 192.1563 62.5765 190.3847 59.1145 192.7727 53.6014 189.1387 51.1344 191.0472 48.6544 188.8624 41.547 193.2716 34.8616 193.1269 32.3478 206.089 32.8233 214.1246 31.3936 221.4488 23.3654 216.8261 18.8224 211.0272 18.2522 201.9126 11.8561 186.7866 25.9231 188.4835 30.7735 186.4215 34.2431 179.5698 35.7459 179.6442 43.1583 172.7247 48.3467 165.562 49.3126 162.3086 48.7921 156.5995 52.9196 157.6227 57.499 152.9404 62.7555 150.7998 64.6275 147.0547 73.105 143.1411" />
      <polygon
        id="臺東縣"
        points="115.2469 145.855 112.5814 155.4235 107.5952 163.5902 108.704 170.3046 104.2135 173.6457 102.8132 178.3049 94.5898 190.5098 91.0035 192.9536 90.2786 198.6495 78.1729 207.3245 68.2066 231.9384 68.3149 238.8423 65.9975 240.1427 60.7584 238.001 59.6111 231.0884 56.3562 229.3874 59.9695 225.4448 56.9939 222.2553 57.9506 219.693 56.045 214.975 59.7431 203.9199 67.3148 202.0164 68.8631 195.5423 65.8322 192.1563 62.4171 182.9336 66.9978 177.1655 67.4795 168.5617 69.8144 161.2936 74.1037 157.9215 78.6455 156.6292 82.6384 161.674 87.3727 164.1093 91.2573 163.938 93.0137 168.5925 97.7401 172.2197 101.1518 171.2346 105.8732 156.7358 109.4653 152.1024 107.7286 149.7368 111.3307 145.1724" />
      <polygon
        id="花蓮縣"
        points="136.9964 76.9623 134.6526 81.1861 129.1627 85.3907 128.3654 91.106 124.8735 94.6218 127.1256 100.9319 124.6162 103.7282 123.2391 112.8196 115.8318 139.3902 115.2469 145.855 111.3307 145.1724 107.7286 149.7368 109.4653 152.1024 105.8732 156.7358 101.1518 171.2346 97.7401 172.2197 93.0137 168.5925 91.2573 163.938 87.3727 164.1093 82.6384 161.674 78.6455 156.6292 80.2646 154.4727 75.4195 151.8085 78.5146 148.1067 77.624 145.8087 81.7909 139.3092 88.2254 138.5004 88.4317 133.9647 93.1052 132.9237 95.3001 124.4009 92.4425 119.4407 94.2965 118.4372 97.1842 111.5764 98.1747 104.3051 96.782 102.2322 102.1255 92.6619 98.4452 91.0001 98.8234 87.7538 103.7898 85.9639 103.2688 84.1393 110.4618 76.3922 111.797 73.0966 123.926 77.1686 125.0755 72.9441" />
      <polygon
        id="桃園市"
        points="98.603 14.167, 107.029 18.572, 107.981 23.438, 102.027 25.132, 101.493 31.194, 105.998 36.336, 108.951 36.257, 111.602 40.135, 109.560 41.922, 113.987 48.905, 112.383 48.959, 107.966 55.333, 108.095 55.709, 107.683 55.445, 105.014 54.578, 104.854 52.884, 104.867 52.828, 105.019 52.345, 104.662 52.039, 104.468 52.059, 104.004 49.449, 102.721 48.164, 100.126 47.394, 100.128 46.450, 100.151 46.245, 100.159 46.203, 100.023 43.523, 100.252 42.390, 98.928 41.485, 97.662 40.926, 97.602 40.728, 96.840 39.878, 96.671 39.565, 94.663 38.732, 93.743 38.903, 92.833 38.288, 92.728 38.450, 92.363 38.300, 91.809 37.647, 90.188 36.606, 89.954 36.387, 89.915 36.373, 88.969 36.113, 88.557 35.140, 88.881 34.501, 88.970 34.272, 88.696 33.262, 88.681 33.250, 88.663 33.230, 88.783 32.988, 88.700 32.883, 88.058 32.677, 87.370 32.597, 87.038 32.908, 86.802 32.794, 86.763 32.794, 85.591 32.634, 85.373 32.579, 85.213 32.486, 85.066 32.018, 85.053 31.635, 83.468 31.607, 83.187 31.457, 83.184 31.451, 82.982 31.316, 80.969 30.787, 81.157 29.749, 79.789 27.763, 79.701 27.775, 79.602 27.824, 79.456 27.628, 79.359 27.591, 78.591 27.814, 78.177 27.974, 77.756 27.945, 77.514 27.877, 76.251 28.035, 75.690 28.433, 75.490 28.197, 78.669 21.774, 83.472 18.456, 96.755 13.713, 98.603 14.167" />
      <polygon
        id="新竹縣"
        points="70.1621 45.5376 69.6858 45.5082 69.6159 44.5352 68.032 44.2977 67.9897 44.281 67.9869 39.6654 70.5781 34.7455 75.49 28.197 75.6904 28.433 76.2506 28.0345 77.514 27.8773 77.7563 27.9446 78.177 27.9738 78.5906 27.8141 79.3594 27.5912 79.4555 27.6277 79.6017 27.8238 79.7006 27.775 79.7893 27.7626 81.1568 29.7494 80.9691 30.7869 82.9821 31.3155 83.1843 31.4507 83.1867 31.4574 83.4683 31.6072 85.0526 31.6346 85.0655 32.0177 85.2128 32.4859 85.3727 32.5788 85.5915 32.6336 86.7625 32.7943 86.8025 32.7935 87.0376 32.908 87.3697 32.5969 88.0578 32.6767 88.7 32.8832 88.7826 32.9882 88.663 33.2304 88.6807 33.2498 88.6964 33.262 88.9704 34.2722 88.8807 34.501 88.5574 35.1404 88.9685 36.1128 89.9154 36.3727 89.9537 36.387 90.1876 36.6058 91.8091 37.6466 92.3626 38.3005 92.7278 38.4501 92.8333 38.2885 93.7435 38.9033 94.6629 38.7319 96.6706 39.5653 96.8402 39.8784 97.6022 40.7283 97.6624 40.926 98.9282 41.4849 100.2516 42.3904 100.0233 43.5227 100.1593 46.2027 100.1507 46.2448 100.1281 46.4499 100.1264 47.3942 102.7212 48.1638 104.0035 49.4485 104.4682 52.0593 104.6623 52.0386 105.0192 52.3445 104.8671 52.8275 104.8537 52.8837 105.0136 54.5783 107.6831 55.4451 108.2186 55.8429 108.4666 56.1879 108.471 56.1986 107.8329 57.5545 107.6871 57.7217 107.133 60.6049 107.1071 60.6147 106.9463 60.7942 106.5917 61.3969 106.156 61.7487 105.9566 61.7448 104.4296 63.5477 104.1 63.628 102.2233 65.4027 101.536 66.4752 101.2849 67.0866 99.4241 67.8293 99.3813 67.8914 98.5884 67.961 98.0939 68.0445 96.6899 67.1465 95.5569 64.7811 94.7897 63.4879 94.694 63.4899 93.8461 62.8913 93.7265 62.7696 89.7256 62.231 88.1136 61.9572 85.9301 61.8315 83.3692 62.5861 82.053 62.5552 82.0764 62.3673 82.5209 59.8491 82.1661 58.6346 81.1778 58.0791 81.0281 57.7637 81.385 57.969 81.7678 57.633 82.1101 56.8686 82.1436 56.7716 82.4519 56.088 82.8941 55.5137 82.8484 54.8913 82.3236 54.3145 82.3805 54.021 82.304 53.7405 82.2917 53.721 81.637 53.3454 81.3637 53.074 80.4541 53.302 80.2729 53.1971 79.7722 52.5562 77.6161 51.4878 77.2353 51.2502 77.2126 51.2424 77.1275 50.9732 77.1483 50.6508 77.2632 50.5095 77.2788 50.4149 77.0688 50.3128 76.4685 50.3916 75.5673 49.7532 75.3095 49.5441 75.0894 49.1907 74.6393 48.9217 74.0174 48.0745 74.3892 46.9827 74.3156 46.6651 73.3892 46.1272 72.7624 46.3762 71.3762 45.8735" />
      <polygon
        id="屏東縣"
        points="65.8322 192.1563 68.8631 195.5423 67.3148 202.0164 59.7431 203.9199 56.045 214.975 57.9506 219.693 56.9939 222.2553 59.9695 225.4448 56.3562 229.3874 59.6111 231.0884 60.7584 238.001 65.9975 240.1427 68.3149 238.8423 68.1084 254.2334 64.0923 262.0401 66.0333 265.7357 57.115 261.6276 53.7833 263.2796 54.0161 259.6418 51.8004 256.254 54.274 250.8276 47.9617 233.6503 44.0023 229.221 31.3936 221.4488 32.8233 214.1246 32.3478 206.089 34.8616 193.1269 41.547 193.2716 48.6544 188.8624 51.1344 191.0472 53.6014 189.1387 59.1145 192.7727 62.5765 190.3847" />
    </g>
  </g>
  <g class="text" {transform}>
    {#each texts as t (t)}
      <text text-anchor="middle" x={centroids[t][0]} y={centroids[t][1]}>
        {t}
      </text>
    {/each}
  </g>
</SVG>

<div>{current}</div>
